<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leave Details</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="/ncpicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/ncpicon.ico" type="image/x-icon">
</head>
<body>

<div id="loadingState" class="loading-state">
  <div class="page-spinner"></div>
  <p>Loading employee details…</p>
</div>

<div id="leavePage" class="hidden">
  <div class="container leave-card">
    <h1 class="card-title">Leave Details</h1>

    <!-- Employee -->
    <div class="field-group">
      <label>Employee</label>
      <input type="text" id="employeeName" readonly />
    </div>

    <!-- Leave type -->
    <div class="field-group">
      <label>Leave Type</label>
      <div class="custom-select">
        <select id="leaveTypeSelect">
          <option value="Sick">Sick Leave</option>
          <option value="Annual">Annual Leave</option>
          <option value="Unpaid">Unpaid Leave</option>
        </select>
      </div>
    </div>

    <!-- Balance -->
    <div class="field-group">
      <label>Available balance</label>
      <input type="text" id="balance" readonly />
    </div>

    <!-- Dates -->
    <div class="row">
      <div class="field-group">
        <label>Start date</label>
        <input type="date" id="startDate" />
      </div>

      <div class="field-group">
        <label>End date</label>
        <input type="date" id="endDate" />
      </div>
    </div>

    <!-- Hours per day -->
    <div class="field-group">
      <label>Hours per day</label>
      <div class="leave-options hours-options">
        <div class="leave-btn active" onclick="setHours(8, this)">
          Full day<br /><small>8 hours</small>
        </div>
        <div class="leave-btn" onclick="setHours(4, this)">
          Half day<br /><small>4 hours</small>
        </div>
      </div>
    </div>

    <!-- Total -->
    <div class="field-group">
      <label>Total leave hours</label>
      <input type="text" id="totalHours" readonly placeholder="—" />
    </div>

    <!-- Reason -->
    <div class="field-group">
      <label>Reason</label>
      <textarea id="reason" placeholder="Brief explanation"></textarea>
    </div>

    <button class="primary-btn" onclick="submitLeave()">Submit</button>

    <p class="hint-text">
      * Sick leave more than 16 hours may require a medical certificate
    </p>
  </div>
</div>

<script>
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbz4zMRShI6IwL7ehez3Q9VX_ysMQb3Otv__59tgoe5-91zfEN1THvLSJjty_TCN24Wp/exec";

const loadingState = document.getElementById("loadingState");
const leavePage = document.getElementById("leavePage");
const leaveTypeSelect = document.getElementById("leaveTypeSelect");
const balance = document.getElementById("balance");
const startDate = document.getElementById("startDate");
const endDate = document.getElementById("endDate");
const totalHours = document.getElementById("totalHours");
const reason = document.getElementById("reason");

let hoursPerDay = 8;
let availableBalanceHours = 0;

/* =====================
   INIT
===================== */
document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("employeeToken");
  const name = localStorage.getItem("employeeName");

  if (!token || !name) {
    alert("Session expired. Please login again.");
    window.location.replace("employee-login.html");
    return;
  }

  loadingState.classList.remove("hidden");
  leavePage.classList.add("hidden");

  document.getElementById("employeeName").value = name;

  await loadBalance();

  leaveTypeSelect.addEventListener("change", loadBalance);

  loadingState.classList.add("hidden");
  leavePage.classList.remove("hidden");
});

/* =====================
   LOAD BALANCE
===================== */
async function loadBalance() {
  const token = localStorage.getItem("employeeToken");
  const type = leaveTypeSelect.value;

  if (type === "Unpaid") {
    availableBalanceHours = Infinity;
    balance.value = "Unpaid Leave: Unlimited";
    calculateTotal();
    return;
  }

  balance.value = "Loading…";

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "getEmployeeBalanceSecure",
      token,
      leaveType: type
    })
  });

  const data = await res.json();

  if (!data.success) {
    console.error("Balance error:", data);
    balance.value = "Unable to load balance";
    return;
  }

  availableBalanceHours = data.balanceHours;
  balance.value = `${type} Balance: ${availableBalanceHours} hours`;
  calculateTotal();
}

/* =====================
   HOURS PER DAY
===================== */
function setHours(hours, btn) {
  hoursPerDay = hours;

  document
    .querySelectorAll(".hours-options .leave-btn")
    .forEach(b => b.classList.remove("active"));

  btn.classList.add("active");
  calculateTotal();
}

/* =====================
   TOTAL HOURS
===================== */
["startDate", "endDate"].forEach(id =>
  document.getElementById(id).addEventListener("change", calculateTotal)
);

function calculateTotal() {
  if (!startDate.value || !endDate.value) {
    totalHours.value = "—";
    return;
  }

  const s = new Date(startDate.value);
  const e = new Date(endDate.value);

  let days = 0;
  for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
    const day = d.getDay();
    if (day !== 0 && day !== 6) days++;
  }

  totalHours.value = `${days * hoursPerDay} hours`;
}

/* =====================
   SUBMIT
===================== */
let submitting = false;

function submitLeave() {
  if (submitting) return;
  submitting = true;

  const submitBtn = document.querySelector(".primary-btn");

  if (!startDate.value || !endDate.value || !reason.value.trim()) {
    alert("Please complete all fields.");
    submitting = false;
    return;
  }

  const total = parseFloat(totalHours.value) || 0;
  const type = leaveTypeSelect.value;

  submitBtn.disabled = true;
  submitBtn.innerText = "Submitting…";
  submitBtn.style.opacity = "0.85";

  if (type !== "Unpaid" && total > availableBalanceHours) {
    alert(
      `Insufficient balance.\n\nRequested: ${total} hours\nAvailable: ${availableBalanceHours} hours`
    );

    submitBtn.disabled = false;
    submitBtn.innerText = "Submit";
    submitBtn.style.opacity = "1";
    submitting = false;
    return;
  }

  const payload = {
    action: "submitLeaveSecure",
    token: localStorage.getItem("employeeToken"),
    leaveType: type,
    startDate: startDate.value,
    endDate: endDate.value,
    hoursPerDay,
    totalHours: total,
    reason: reason.value.trim()
  };

  fetch(SCRIPT_URL, {
    method: "POST",
    body: new URLSearchParams(payload)
  })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        alert(data.message || "Submission failed.");
        submitBtn.disabled = false;
        submitBtn.innerText = "Submit";
        submitBtn.style.opacity = "1";
        submitting = false;
        return;
      }

      submitBtn.innerText = "Submitted ✓";
      submitBtn.style.background = "#22c55e";

      setTimeout(() => {
        window.location.href = "submitted.html";
      }, 600);
    })
    .catch(() => {
      alert("Submission failed. Please try again.");
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit";
      submitBtn.style.opacity = "1";
      submitting = false;
    });
}
</script>

</body>
</html>
