<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leave Submissions</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="/ncpicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/ncpicon.ico" type="image/x-icon">
</head>
<body>

<!-- BACK BUTTON -->
<div class="admin-icon" onclick="goBack()">Back</div>

<!-- HEADER -->
<div class="admin-header">
  <div class="admin-left">
    Admin: <strong id="adminName"></strong>
  </div>

  <div class="admin-center">
    <div class="admin-title">Leave Submissions</div>
    <div class="admin-subtitle">Pending Leave Requests</div>
  </div>
</div>

<!-- CONTENT -->
<div class="container" style="width: 900px; margin-top: 110px;">
  <div id="no-requests" class="empty-state" style="display:none;">
    No pending leave requests ðŸŽ‰
  </div>

  <div id="requests"></div>
</div>

<!-- MODAL -->
<div id="modal-overlay" class="modal-overlay">
  <div class="modal">
    <p id="modal-message"></p>
    <button class="primary-btn" onclick="closeModal()">OK</button>
  </div>
</div>

<script>
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbz4zMRShI6IwL7ehez3Q9VX_ysMQb3Otv__59tgoe5-91zfEN1THvLSJjty_TCN24Wp/exec";

/* =========================
   AUTH GUARD
========================= */
if (localStorage.getItem("isAdmin") !== "true") {
  window.location.replace("admin-login.html");
}

document.getElementById("adminName").textContent =
  localStorage.getItem("adminName") || "Admin";

/* =========================
   LOAD PENDING LEAVES
========================= */
const container = document.getElementById("requests");
const emptyState = document.getElementById("no-requests");

fetch(SCRIPT_URL + "?action=getPendingLeaves")
  .then(res => res.json())
  .then(data => {
    if (!data.success || !data.leaves || data.leaves.length === 0) {
      emptyState.style.display = "block";
      return;
    }

    data.leaves.forEach(l => {
      const days = calculateDays(l.startDate, l.endDate);

      const card = document.createElement("div");
      card.className = "request-card";

      card.innerHTML = `
        <div class="request-body">
  <div class="request-top">
    <div class="employee-name">${l.employeeName}</div>
    <span class="status-badge pending">Pending</span>
  </div>

  <div class="meta">
    <span class="pill">${l.leaveType} Leave</span>
    <span class="pill">${l.totalHours} hrs</span>
  </div>

  <div class="dates">
    ðŸ“… ${formatDate(l.startDate)} â†’ ${formatDate(l.endDate)}
    <span class="days">(${days} day${days > 1 ? "s" : ""})</span>
  </div>

  <div class="reason">
    <strong>Reason:</strong> ${l.reason || "-"}
  </div>
</div>


        <div class="request-actions">
          <button class="primary-btn"
            onclick="updateStatus(${l.rowIndex}, 'Approved', this)">
            Approve
          </button>

          <button class="secondary-btn"
            onclick="updateStatus(${l.rowIndex}, 'Rejected', this)">
            Reject
          </button>
        </div>
      `;

      container.appendChild(card);
    });
  })
  .catch(() => {
    emptyState.style.display = "block";
  });

/* =========================
   UPDATE STATUS
========================= */
function updateStatus(rowIndex, status, btn) {
  // visual feedback immediately
  btn.disabled = true;
  const originalText = btn.innerText;
  btn.innerText = status === "Approved" ? "Approvingâ€¦" : "Rejectingâ€¦";
  btn.style.opacity = "0.8";

  const card = btn.closest(".request-card");
  card.style.opacity = "0.85";

  const formData = new FormData();
  formData.append("action", "updateLeaveStatus");
  formData.append("rowIndex", rowIndex);
  formData.append("status", status);
  formData.append("adminName", localStorage.getItem("adminName"));

  fetch(SCRIPT_URL, { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        // rollback UI if failed
        btn.disabled = false;
        btn.innerText = originalText;
        btn.style.opacity = "1";
        card.style.opacity = "1";
        alert("Failed to update leave status");
        return;
      }

      // success animation
      card.style.transform = "scale(0.98)";
      card.style.opacity = "0";

      setTimeout(() => {
        card.remove();
      }, 250);

      if (container.children.length === 1) {
        emptyState.style.display = "block";
      }

      showModal(`Leave ${status.toLowerCase()}`);
    })
    .catch(() => {
      btn.disabled = false;
      btn.innerText = originalText;
      btn.style.opacity = "1";
      card.style.opacity = "1";
      alert("Server error");
    });
}


/* =========================
   HELPERS
========================= */
function formatDate(d) {
  return new Date(d).toLocaleDateString();
}

function calculateDays(start, end) {
  const s = new Date(start);
  const e = new Date(end);
  let days = 0;

  for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
    const day = d.getDay();
    if (day !== 0 && day !== 6) days++;
  }
  return days;
}

function showModal(msg) {
  document.getElementById("modal-message").innerText = msg;
  document.getElementById("modal-overlay").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal-overlay").style.display = "none";
}

function goBack() {
  window.location.href = "admin-dashboard.html";
}
</script>

</body>
</html>
